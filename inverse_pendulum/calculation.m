g=9.8;

m1=1;
m2=1;
l1=1;
l2=1;
I1=1;
I2=1;
Km=1;

a21=((-m1*g*l1)*(m1*l2^2+m2*l2^2+I2))/((m1*l1*l2+m1*l2^2+m2*l2^+I2)^2-(m1*l2^2+m2*l2^2+I2)*(m1*l1^2+2*m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2));
a24=((-2*Km^2)*(m1*l1*l2+m1*l2^2+m2*l2^2+I2))/((m1*l1*l2+m1*l2^2+m2*l2^2+I2)^2-(m1*l2^2+m2*l2^2+I2)*(m1*l1^2+2*m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2));
a41=((m1*g*l1)*(m1*l1*l2+m1*l2^2+m2+m2*l2^2+I2))/((m1*l1*l2+m1*l2^2+m2*l2^+I2)^2-(m1*l2^2+m2*l2^2+I2)*(m1*l1^2+2*m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2));
a44=((2*Km^2)*(m1*l1^2+m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2))/((m1*l1*l2+m1*l2^2+m2*l2^2+I2)^2-(m1*l2^2+m2*l2^2+I2)*(m1*l1^2+2*m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2));
b2=((2*Km)*(m1*l1*l2+m1*l2^2+m2*l2^2+I2))/((m1*l1*l2+m1*l2^2+m2*l2^2+I2)^2-(m1*l2^2+m2*l2^2+I2)*(m1*l1^2+2*m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2));
b4=((-2*Km)*(m1*l1^2+2*m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2))/((m1*l1*l2+m1*l2^2+m2*l2^2+I2)^2-(m1*l2^2+m2*l2^2+I2)*(m1*l1^2+2*m1*l1*l2+m1*l2^2+m2*l2^2+I1+I2));

A=[...
  0 1 0 0
  a21 0 0 a24
  0 0 0 1
  a41 0 0 a44];
B= [0;b2;0;b4];
C=[0 1 0 0];

Ae=[A zeros(4,1)
    -C zeros(1,1)];

Be=[B
    zeros(1,1)];

M0 = [A B
      C 0];
  
% Q11=100;
 Q22=600;
% Qe=[C'*Q11*C zeros(4,1)
%    zeros(1,4) Q22];
Qe=[...
  1 0 0 0 0 
  0 1 0 0 0
  0 0 5000 0 0
  0 0 0 1 0
  0 0 0 0 Q22];
Re=500;
Pe=care(Ae,Be,Qe,Re);
P11=Pe(1:4,1:4);
P12=Pe(1:4,5);
P22=Pe(5,5);

K=-inv(Re)*B'*P11;
G=-inv(Re)*B'*P12;

Fa = [-K+2*G*inv(P22)*P12' 1]*inv(M0)*[zeros(4,1); 1];

Fb=-2*G*inv(P22)*P12';
